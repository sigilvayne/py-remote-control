<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Центр керування серверами</title>
    <link href="https://cdn-uicons.flaticon.com/uicons-thin-straight/css/uicons-thin-straight.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <div class="user-info">
            <div class="user-icon"><i class="fi fi-tr-circle-user"></i></div>
            <div class="username">{{ username }}</div>
            <button class="logout-btn" onclick="window.location.href='/logout'">Вийти</button>
        </div>
    </header>

    <div class="content">
        <div class="left-panel">
            <h2>Команди</h2>
            <ul id="command-list">
                <li>ipconfig</li>
                <li>whoami</li>
                <li>hostname</li>
                <li>tasklist</li>
                <li>netstat -an</li>
                <li>shutdown /r /t 0</li>
                <li>sc query</li>
                <li>systeminfo</li>
            </ul>
        </div>

        <div class="right-panel">
            <h2>Сервери</h2>
            <ul id="server-list"></ul>
            <input type="text" id="server-id" placeholder="Введіть ім'я серверу вручну...">
        </div>


        <div class="main-panel">
            <div class="command-editor">
                <h2>Команда</h2>
                <textarea id="command-input" rows="3" placeholder="Оберіть команду або введіть свою..."></textarea>
                <button onclick="sendCommand()">Надіслати</button>
            </div>
            <div class="command-output" id="command-output">
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll('#command-list li').forEach(item => {
            item.addEventListener('click', () => {
                document.getElementById('command-input').value = item.innerText;
            });
        });

        async function sendCommand() {
            const serverId = document.getElementById('server-id').value.trim();
            const command = document.getElementById('command-input').value.trim();

            if (!serverId || !command) {
                alert("Введіть ім'я серверу та команду.");
                return;
            }

            await fetch(`/set_command/${serverId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ command })
            });

            const output = document.getElementById('command-output');
            output.innerHTML = "<em>Очікуємо результат...</em>";

            let tries = 30;
            while (tries-- > 0) {
                const res = await fetch(`/get_result/${serverId}`);
                const data = await res.json();
                if (data.status !== "no_result") {
                    output.textContent = data.output || JSON.stringify(data);
                    return;
                }
                await new Promise(r => setTimeout(r, 1000));
            }

            output.innerHTML = "<em>Результат не отримано.</em>";
        }

        // Завантажуємо список серверів при відкритті сторінки
        async function loadServers() {
            const res = await fetch('/servers');
            const servers = await res.json();
            const list = document.getElementById('server-list');
            list.innerHTML = '';
            servers.forEach(server => {
                const li = document.createElement('li');
                li.textContent = server;
                li.addEventListener('click', () => {
                    document.getElementById('server-id').value = server;
                });
                list.appendChild(li);
            });
        }

        loadServers(); // Виклик під час завантаження сторінки
    </script>

</body>
</html>
