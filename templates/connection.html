<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Центр керування серверами</title>
    <link rel="icon" type="image/png" href="/static/images/icon.png">
    <link href="https://cdn-uicons.flaticon.com/uicons-thin-straight/css/uicons-thin-straight.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <img src="/static/images/icon.png" alt="Лого" class="header-icon">
        <div class="user-info">
            <div class="user-icon"><i class="fi fi-tr-circle-user"></i></div>
            <div class="username">{{ username }}</div>
            <button class="logout-btn" onclick="window.location.href='/logout'">Вийти</button>
        </div>
    </header>


    <div class="content">
        <div class="left-panel">
            <h2>Команди</h2>
            <ul id="command-list">
                <li>ipconfig</li>
                <li>whoami</li>
                <li>hostname</li>
                <li>tasklist</li>
                <li>netstat -an</li>
                <li>shutdown /r /t 0</li>
                <li>sc query</li>
                <li>systeminfo</li>
            </ul>
        </div>

        <div class="right-panel">
            <h2>Сервери</h2>
            <ul id="server-list"></ul>
            <input type="text" id="server-id" placeholder="Введіть ім'я серверу вручну...">
        </div>

        <div class="main-panel">
            <div class="command-editor">
                <h2>Команда</h2>
                <textarea id="command-input" rows="3" placeholder="Оберіть команду або введіть свою..."></textarea>
                <button onclick="sendCommand()">Надіслати</button>
            </div>
            <div class="command-output" id="command-output">
            </div>
        </div>
    </div>

    <script>
        let selectedServers = new Set();

        function updateServerSelectionUI() {
            document.querySelectorAll('#server-list li').forEach(li => {
                const sid = li.dataset.sid;
                if (selectedServers.has(sid)) {
                    li.classList.add('selected');
                } else {
                    li.classList.remove('selected');
                }
            });
        }

        async function sendCommand() {
            const command = document.getElementById('command-input').value.trim();

            if (selectedServers.size === 0 || !command) {
                alert("Оберіть принаймні один сервер та введіть команду.");
                return;
            }

            const output = document.getElementById('command-output');
            output.innerHTML = `<em>Надсилаємо команду на ${selectedServers.size} серверів...</em>`;

            // Надсилання команди на кожен сервер
            for (const sid of selectedServers) {
                await fetch(`/set_command/${sid}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ command })
                });
            }

            // Очікування результатів
            let tries = 30;
            let results = {};
            while (tries-- > 0) {
                for (const sid of selectedServers) {
                    if (results[sid]) continue;

                    const res = await fetch(`/get_result/${sid}`);
                    const data = await res.json();
                    if (data.status !== "no_result") {
                        results[sid] = data;
                    }
                }

                if (Object.keys(results).length === selectedServers.size) break;
                await new Promise(r => setTimeout(r, 1000));
            }

            let finalOutput = "";
            for (const sid of selectedServers) {
                const res = results[sid];
                if (res) {
                    finalOutput += `<strong>${sid}</strong><pre>${res.stdout || "No output"}</pre>`;
                } else {
                    finalOutput += `<strong>${sid}</strong>: <em>Немає результату</em><br>`;
                }
            }

            output.innerHTML = finalOutput;
        }

        async function loadServers() {
            const res = await fetch('/servers');
            const servers = await res.json();
            const list = document.getElementById('server-list');
            list.innerHTML = '';
            servers.forEach(server => {
                const li = document.createElement('li');
                li.textContent = server;
                li.dataset.sid = server;
                li.addEventListener('click', () => {
                    if (selectedServers.has(server)) {
                        selectedServers.delete(server);
                    } else {
                        selectedServers.add(server);
                    }
                    updateServerSelectionUI();
                });
                list.appendChild(li);
            });
        }

        // Команда з лівого списку
        document.querySelectorAll('#command-list li').forEach(item => {
            item.addEventListener('click', () => {
                document.getElementById('command-input').value = item.innerText;
            });
        });

        loadServers();
    </script>

</body>
</html>
